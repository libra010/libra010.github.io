服务网关

Spring Cloud Gateway



## 路由转发

作为服务网关，Spring Cloud Gateway 的核心功能是实现请求的**路由转发**。能够根据预定义的规则，将客户端请求精准地转发到后端对应的服务。

路由配置支持两种方式：**基于 YAML 配置文件的声明式配置** 和 **基于 Java 代码的编程式配置**。

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: after_route                   # 路由唯一标识（ID）
          uri: https://example.org          # 请求转发的目标地址
          predicates:                       # 匹配条件（谓词），多个条件为“与”关系
            - Path=/api/users/**            # 匹配以 /api/users/ 开头的路径
            - Method=GET                    # 仅匹配 GET 请求方法
          filters:                          # 过滤器链，在请求转发前后执行处理逻辑
            - AddRequestHeader=Authorization, Bearer xxx  # 添加请求头
```

```java
@Bean
public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
    return builder.routes()
        .route(r -> r.path("/blog")         // 匹配 /blog 路径的请求
                   .uri("http://www.throwable.club")  // 转发至指定 URI
        )
        .build();
}
```





## 谓词 Predicate 

在路由配置中，通过 `predicates` 属性定义匹配条件，用于根据请求的各类参数对路由规则进行判断和匹配。

Spring Cloud Gateway 内置了一些路由谓词工厂（`RoutePredicateFactory`），用于实现常见的匹配场景。

比如：After/Before/Between（用于请求时间判断），Cookie（HTTP Cookie），Header（请求头），Host（主机名），Method（HTTP方法），Path（HTTP路径），Query（HTTP查询字符串）等等。





## 过滤器 Filter

在路由配置中，通过 `filters` 属性定义一系列过滤器，用于在请求被转发前（pre）或响应返回后（post）对请求和响应进行处理。这些过滤器以责任链的方式串联执行，形成过滤器链（Filter Chain），实现对请求的增强与控制。

Spring Cloud Gateway 提供了多个内置的 GatewayFilter 工厂，用于快速实现常见的请求处理逻辑。

比如：AddRequestHeader（添加请求头），AddRequestParameter（添加查询字符串），AddResponseHeader（添加响应请求头），RewritePath（重写路径），RequestRateLimiter（限流）





## 全局过滤器 GlobalFilter

前述的 **过滤器（Filter）** 是路由级别的，仅作用于配置了该过滤器的特定路由。除此之外，Spring Cloud Gateway 还提供了 **全局过滤器（GlobalFilter）**。

全局过滤器会自动作用于所有路由，无需在 YAML 配置中显式声明，也无法通过配置文件进行定义。它必须通过 Java 编程式方式实现和注册，通常用于处理跨路由的通用逻辑，如身份认证、请求日志记录、请求上下文传递等。





## 底层实现

无论是通过 YAML 配置文件定义路由，还是通过 Java 编程式方式构建 `RouteLocator` 实例，最终都会被统一转化为一个 `RouteDefinition` 集合。

`RouteDefinition` 是路由配置的抽象模型，代表了所有静态或动态的路由规则集合。Spring Cloud Gateway 内部通过 `RouteDefinitionRouteLocator` 将这些 `RouteDefinition` 对象转换为最终可执行的 `Route` 对象。该 `Route` 对象封装了实际生效的谓词（Predicate）和过滤器链（Filter），是网关执行请求匹配与转发的核心实体。

此外，除了 YAML 配置和编程式配置，Spring Cloud Gateway 还支持从外部数据源（如配置中心、数据库、Redis 等）加载路由配置，实现外部化路由管理。这些外部配置在加载后，同样会被转换为统一的 `RouteDefinition` 集合，从而实现配置来源的透明化。

动态路由：路由的动态刷新通常与外部配置源结合使用。当外部路由配置发生变化时，可通过调用 Actuator 提供的 `/actuator/gateway/refresh` 端点，触发路由配置的重新加载与更新。





## CORS 配置

Spring Cloud Gateway 支持通过 `globalcors` 配置项统一管理跨域资源共享（CORS）策略。

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':  # 匹配所有路径
            allowedOrigins: "https://docs.spring.io"  # 允许的请求源
            allowedMethods:  # 允许的 HTTP 方法
              - GET
```





## Actuator API

Spring Cloud Gateway 集成 Spring Boot Actuator，提供了一系列监控和管理端点，可用于查询网关状态和动态操作路由。

`/actuator/gateway/routes` ：检索路由详细信息。

`/actuator/gateway/globalfilters` ：检索全局过滤器链。

`/actuator/gateway/refresh` ：刷新路由缓存。





## 自定义谓词和过滤器

Spring Cloud Gateway 支持自定义谓词工厂（RoutePredicateFactory）和过滤器工厂（GatewayFilterFactory），以满足特定业务场景下的匹配或处理需求。

自定义的工厂类实现后，可在 YAML 配置文件中直接使用，与内置工厂的用法保持一致，从而实现灵活、可配置的扩展能力。





## 身份认证与鉴权

Spring Cloud Gateway 本身没有身份认证与鉴权功能，可以通过自定义过滤器来实现。

一般是通过GlobalFilter全局过滤器进行认证授权的，另外也可以集成Spring Security来进行。



## 限流熔断和降级

可以参考若依文档：https://doc.ruoyi.vip/ruoyi-cloud/cloud/gateway.html

可以集成 Alibaba Sentinel 进行限流。







END