微服务支撑架构



在微服务架构中，系统被拆分为多个独立部署的服务，带来了灵活性和可扩展性的同时，也显著增加了运维和问题排查的复杂度。为了保障系统的稳定性与可维护性，构建一套完善的支撑架构（尤其是可观测性体系）至关重要。

其中，可观测性（Observability） 是指通过系统对外暴露的输出信息（如日志、指标、追踪数据），推断其内部运行状态的能力。它帮助开发与运维人员快速定位问题、分析性能瓶颈，并实现主动预警。

可观测性通常由三大支柱构成：

- 日志（Logging）
- 指标监控（Metrics）
- 链路追踪（Tracing）





## 日志 ELK

在分布式系统中，日志分散于大量服务实例中，传统方式难以高效检索与分析。因此，需要一个集中式日志管理平台来实现日志的统一收集、存储与可视化。

ELK 是三个开源工具的统称，共同构成完整的日志处理流水线。

Elasticsearch（存储与搜索引擎）Logstash（日志收集与处理管道）Kibana（数据可视化平台）



另外，在Kubernetes微服务架构中，可以采用轻量级的代替产品**Loki**。





## 指标监控 Prometheus Grafana

Prometheus 与 Grafana 的组合已成为现代 Java 微服务项目中事实上的监控标准，尤其在云原生和 Kubernetes 环境中广泛应用。

Prometheus（监控系统，与Kubernetes同为CNCF基金会的开源项目）它是一个时间序列数据库，采用 Pull 模型，通过定期向目标服务的 HTTP 接口发起请求，主动拉取指标数据。

Grafana（可视化平台）



Java应用本身不能直接被Prometheus监控，需要通过Micrometer暴露指标。

Micrometer是Java生态中事实上的指标门面（门面，类似于SLF4J之于日志）

Spring Boot 2 的 Actuator 模块已经默认集成了Micrometer。Actuator提供HTTP接口暴露，底层使用Micrometer的监控数据。

Micrometer 通过多种方式收集数据：主要利用 JMX API 获取 JVM 相关数据，另外也收集Spring MVC的HTTP数据和数据库的DataSource连接池的指标数据等。



Spring Boot Admin：一些Java微服务项目使用SBA来进行 Spring Boot 应用的集中管理，它通过Actuator也可以查看性能数据，也支持日志的集中查看，还有Spring env 的配置查看等功能。在中小型项目中可作为轻量级监控管理门户。



StatsD：一些微服务项目采用StatsD，这是一个指标聚合的组件，各个微服务通过StatsD客户端库将监控数据推送push给StatsD服务器，StatsD将他们进行周期性聚合，最后存储到一个后端存储程序中，通常采用Graphite存储。最后，使用 Grafana 等工具连接 Graphite/InfluxDB 来查询和展示数据。StatsD和Graphite的组合类似于Prometheus。





## 链路追踪 SkyWalking

在微服务架构中，一次用户请求可能经过多个服务节点。

链路追踪将一次分布式请求还原为完整的调用链路，进行展示。

Apache SkyWalking 是目前 Java 微服务中最流行的链路追踪解决方案，由中国开发者创建。

另外 CNCF 毕业项目 Jaeger 和 OpenTelemetry 在云原生中比较流行。



SkyWalking 基于 Java Agent 字节码增强，对业务代码无侵入。只需要在 Java 启动命令中添加 -javaagent 参数，并配置好服务名和后端地址，即可实现对 Spring Boot 等 Java 应用的全自动、无侵入式链路追踪。

```bash
java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar \
     -Dskywalking.agent.service_name=my-service \
     -Dskywalking.collector.backend_service=127.0.0.1:11800 \
     -jar your-application.jar
```

SkyWalking 支持主流框架比如Spring MVC，Dubbo，gRPC等等。SkyWalking Agent 在类加载时动态修改字节码。例如，当加载 DispatcherServlet 时，会在 doDispatch 方法前后插入追踪代码，记录请求的开始、结束、异常等上下文信息。



在 Spring Cloud 中也有原生的链路追踪组件 **Spring Cloud Sleuth** ，只负责生成和传递追踪上下文，不处理数据的存储和可视化。可视化UI界面通常采用 Zipkin 来实现。随着 OpenTelemetry 的兴起，Sleuth 的发展重心已转向与 OpenTelemetry 集成，原生支持 Zipkin 的模式逐渐被视为“传统”方案。



https://www.mianshiya.com/bank/1797453053310402561/question/1796163389530177538







END